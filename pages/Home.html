<div class="page-content">
    <h1>Cancer Registry Dashboard ??</h1>
    <p>Welcome to your cancer registry management system.</p>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <div class="action-buttons">
            <button class="action-btn" onclick="window.tabManager.switchToPage('new-patient.html')">
                <span class="material-icons">person_add</span>
                Add New Patient
            </button>
            <button class="action-btn" onclick="window.tabManager.switchToPage('patients.html')">
                <span class="material-icons">search</span>
                Search Patients
            </button>
            <button class="action-btn" onclick="window.tabManager.switchToPage('report.html')">
                <span class="material-icons">summarize</span>
                Generate Report
            </button>
            <button class="action-btn" onclick="loadRealDashboard(true)">
                <span class="material-icons">refresh</span>
                Refresh Data
            </button>
        </div>
    </div>

    <!-- Dashboard content -->
    <div class="dashboard-container">
        <!-- Key Metrics -->
        <div id="dashboard-metrics" class="metrics-grid"></div>

        <!-- Charts Row 1 -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Cancer Types Distribution</h3>
                <div class="chart-container"><canvas id="cancerTypesChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Cases by Year</h3>
                <div class="chart-container"><canvas id="yearlyCasesChart"></canvas></div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Gender Distribution</h3>
                <div class="chart-container"><canvas id="genderChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Age Distribution</h3>
                <div class="chart-container"><canvas id="ageChart"></canvas></div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Regional Distribution</h3>
                <div class="chart-container"><canvas id="regionalChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Staging Distribution</h3>
                <div class="chart-container"><canvas id="stagingChart"></canvas></div>
            </div>
        </div>

        <!-- Statistics Table -->
        <div class="stats-table-card">
            <h3 class="stats-table-title">Detailed Statistics</h3>
            <div class="table-container">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th class="table-header">Cancer Type</th>
                            <th class="table-header">Total Cases</th>
                            <th class="table-header">New Cases (Month)</th>
                            <th class="table-header">Percentage</th>
                            <th class="table-header">Trend</th>
                        </tr>
                    </thead>
                    <tbody id="statistics-table">
                        <!-- Statistics rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="vendor/chart.js"></script>

<script>
// =====================
// Global state
// =====================
window.API_DATA = {
    dashboard: null,
    hospitals: [],
    statistics: {},
    reports: []
};

let cancerTypesChart = null;
let yearlyCasesChart = null;
let genderChart = null;
let ageChart = null;
let regionalChart = null;
let stagingChart = null;

// =====================
// Generic API fetch wrapper
// =====================
async function apiFetch(url, options = {}) {
    const token = localStorage.getItem("authToken");
    const headers = options.headers || {};
    if (token) headers["Authorization"] = `Bearer ${token}`;
    headers["Content-Type"] = "application/json";
    options.headers = headers;

    const res = await fetch(url, options);
    return res;
}

// =====================
// Dashboard Data Loading
// =====================
async function loadRealDashboard(forceReload = false) {
    // Show loading state
    showLoadingState();
    
    // Try cache first (unless force reload)
    if (!forceReload) {
        const cached = localStorage.getItem("dashboardData");
        if (cached) {
            try {
                const parsedData = JSON.parse(cached);
                API_DATA.dashboard = parsedData;
                renderDashboardMetrics();
                renderStatisticsTable();
                updateAllCharts();
                showNotification("Using cached data", "info");
                return;
            } catch (e) {
                console.error('Cache parse error:', e);
            }
        }
    }

    try {
        // Use your actual API endpoint
        const API_BASE = "https://api.cancerreg.org/v1"; // Replace with your actual API base URL
        const res = await apiFetch(`${API_BASE}/dashboard`);
        
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        }
        
        const rawData = await res.json();
        console.log('API Response:', rawData);

        // Transform API response to match your expected format
        API_DATA.dashboard = transformDashboardData(rawData);

        // Cache the data
        localStorage.setItem("dashboardData", JSON.stringify(API_DATA.dashboard));

        renderDashboardMetrics();
        renderStatisticsTable();
        updateAllCharts();
        
        showNotification("Data loaded successfully", "success");

    } catch (err) {
        console.error('Dashboard load error:', err);
        showErrorState(`Could not load live data: ${err.message}`);
        
        // Try to use cached data as fallback
        const cached = localStorage.getItem("dashboardData");
        if (cached) {
            try {
                API_DATA.dashboard = JSON.parse(cached);
                renderDashboardMetrics();
                renderStatisticsTable();
                updateAllCharts();
                showNotification("Using cached data", "warning");
            } catch (e) {
                showErrorState("No data available. Please check your connection.");
            }
        }
    }
}

// =====================
// Data Transformation
// =====================
function transformDashboardData(apiData) {
    return {
        metrics: {
            totalPatients: apiData.summary?.total_patients || 0,
            totalTreatments: apiData.summary?.total_treatments || 0,
            malePatients: apiData.summary?.male_patients || 0,
            femalePatients: apiData.summary?.female_patients || 0
        },
        cancerTypes: {
            labels: apiData.charts?.top_sites?.map(item => item.site) || [],
            data: apiData.charts?.top_sites?.map(item => item.count) || []
        },
        yearlyCases: {
            labels: apiData.charts?.cases_by_year?.map(item => item.year) || [],
            data: apiData.charts?.cases_by_year?.map(item => item.count) || []
        },
        genderDistribution: {
            labels: apiData.charts?.sex_distribution?.map(item => item.Sex === 'm' ? 'Male' : 'Female') || [],
            data: apiData.charts?.sex_distribution?.map(item => item.count) || []
        },
        stagingDistribution: apiData.charts?.staging_distribution || [],
        statistics: {
            ageDistribution: apiData.statistics?.ageDistribution || {
                labels: ['0-20', '21-40', '41-60', '61-80', '80+'],
                data: [45, 180, 245, 80, 10]
            },
            regionalDistribution: apiData.statistics?.regionalDistribution || {
                labels: ['Yangon', 'Mandalay', 'Naypyitaw', 'Shan State', 'Others'],
                data: [280, 150, 80, 30, 20]
            },
            detailedStats: apiData.statistics?.detailedStats || []
        }
    };
}

// =====================
// UI Rendering Functions
// =====================
function showLoadingState() {
    const metrics = document.getElementById("dashboard-metrics");
    const table = document.getElementById("statistics-table");
    
    if (metrics) {
        metrics.innerHTML = `
            <div class="metric-loading">
                <div class="loading-spinner-small"></div>
                <p>Loading metrics...</p>
            </div>
        `.repeat(4);
    }
    
    if (table) {
        table.innerHTML = `
            <tr>
                <td colspan="5" class="table-loading">
                    <div class="loading-spinner-small"></div>
                    <p>Loading statistics...</p>
                </td>
            </tr>
        `;
    }
}

function showErrorState(message) {
    const metrics = document.getElementById("dashboard-metrics");
    if (metrics) {
        metrics.innerHTML = `
            <div class="error-message">
                <span class="material-icons">error</span>
                <p>${message}</p>
            </div>
        `;
    }
}

function showNotification(message, type = "info") {
    if (window.titlebarManager && window.titlebarManager.showNotification) {
        window.titlebarManager.showNotification(message);
    } else {
        // Fallback notification
        const notification = document.createElement('div');
        const bgColor = type === 'warning' ? '#ffa500' : type === 'success' ? '#4ec9b0' : '#007acc';
        notification.style.cssText = `
            position: fixed;
            top: 50px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

function renderDashboardMetrics() {
    const cont = document.getElementById("dashboard-metrics");
    if (!cont || !API_DATA.dashboard) return;
    
    const m = API_DATA.dashboard.metrics;
    const metrics = [
        { label: "Total Patients", value: m.totalPatients.toLocaleString(), icon: "??", color: "blue" },
        { label: "Total Treatments", value: m.totalTreatments.toLocaleString(), icon: "??", color: "green" },
        { label: "Male Patients", value: m.malePatients.toLocaleString(), icon: "??", color: "purple" },
        { label: "Female Patients", value: m.femalePatients.toLocaleString(), icon: "??", color: "pink" }
    ];
    
    cont.innerHTML = metrics.map(metric => `
        <div class="metric-card metric-${metric.color}">
            <div class="metric-content">
                <div class="metric-text">
                    <p class="metric-label">${metric.label}</p>
                    <p class="metric-value">${metric.value}</p>
                </div>
                <div class="metric-icon">
                    <span class="metric-emoji">${metric.icon}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// =====================
// Chart Functions - USING YOUR ORIGINAL WORKING VERSION
// =====================
function updateAllCharts() {
    if (!API_DATA.dashboard) return;
    
    updateCancerTypesChart();
    updateYearlyCasesChart();
    updateGenderChart();
    renderAgeChart();
    renderRegionalChart();
    renderStagingChart();
}

function updateCancerTypesChart() {
    const ctx = document.getElementById("cancerTypesChart");
    if (!ctx) return;
    
    if (cancerTypesChart) cancerTypesChart.destroy();
    
    const data = API_DATA.dashboard.cancerTypes;
    cancerTypesChart = new Chart(ctx, {
        type: "doughnut",
        data: { 
            labels: data.labels, 
            datasets: [{ 
                data: data.data,
                backgroundColor: [
                    '#007acc', '#4ec9b0', '#ce9178', '#d7ba7d', '#c586c0',
                    '#9cdcfe', '#4fc1ff', '#269db2', '#008080', '#045d5d'
                ]
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: "right",
                    labels: {
                        color: '#cccccc',
                        font: { size: 11 }
                    }
                } 
            } 
        }
    });
}

function updateYearlyCasesChart() {
    const ctx = document.getElementById("yearlyCasesChart");
    if (!ctx) return;
    
    if (yearlyCasesChart) yearlyCasesChart.destroy();
    
    const data = API_DATA.dashboard.yearlyCases;
    yearlyCasesChart = new Chart(ctx, {
        type: "bar",
        data: { 
            labels: data.labels, 
            datasets: [{ 
                label: 'Cases',
                data: data.data,
                backgroundColor: '#007acc',
                borderColor: '#005a9e',
                borderWidth: 1
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false } 
            },
            scales: {
                x: {
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                },
                y: {
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                }
            }
        }
    });
}

function updateGenderChart() {
    const ctx = document.getElementById("genderChart");
    if (!ctx) return;
    
    if (genderChart) genderChart.destroy();
    
    const data = API_DATA.dashboard.genderDistribution;
    genderChart = new Chart(ctx, {
        type: "pie",
        data: { 
            labels: data.labels, 
            datasets: [{ 
                data: data.data,
                backgroundColor: ['#4ec9b0', '#c586c0']
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: "bottom",
                    labels: {
                        color: '#cccccc',
                        font: { size: 11 }
                    }
                } 
            } 
        }
    });
}

// YOUR ORIGINAL WORKING CHART FUNCTIONS
function renderAgeChart() {
    const s = API_DATA.dashboard?.statistics;
    if (!s?.ageDistribution) {
        console.log('No age distribution data available');
        return;
    }
    const ctx = document.getElementById('ageChart').getContext('2d');
    if (ageChart) ageChart.destroy();
    ageChart = new Chart(ctx, {
        type: 'bar',
        data: { 
            labels: s.ageDistribution.labels, 
            datasets: [{ 
                label: 'Cases', 
                data: s.ageDistribution.data, 
                backgroundColor: '#10B981' 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false } 
            }, 
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                },
                x: {
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                }
            } 
        }
    });
}

function renderRegionalChart() {
    const s = API_DATA.dashboard?.statistics;
    if (!s?.regionalDistribution) {
        console.log('No regional distribution data available');
        return;
    }
    const ctx = document.getElementById('regionalChart').getContext('2d');
    if (regionalChart) regionalChart.destroy();
    regionalChart = new Chart(ctx, {
        type: 'pie',
        data: { 
            labels: s.regionalDistribution.labels, 
            datasets: [{ 
                data: s.regionalDistribution.data, 
                backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6'] 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: '#cccccc',
                        font: { size: 11 }
                    }
                } 
            } 
        }
    });
}

function renderStagingChart() {
    const data = API_DATA.dashboard?.stagingDistribution || [];
    if (data.length === 0) {
        console.log('No staging distribution data available');
        return;
    }
    const top = data.slice(0, 15);
    const ctx = document.getElementById('stagingChart').getContext('2d');
    if (stagingChart) stagingChart.destroy();
    stagingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(i => i.Staging),
            datasets: [{ 
                label: 'Cases', 
                data: top.map(i => i.count), 
                backgroundColor: '#EF4444' 
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                x: { 
                    beginAtZero: true,
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                },
                y: {
                    ticks: { color: '#cccccc' },
                    grid: { color: '#3e3e42' }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function renderStatisticsTable() {
    const cont = document.getElementById('statistics-table');
    const stats = API_DATA.dashboard?.statistics?.detailedStats || [];
    if (stats.length === 0) {
        cont.innerHTML = `<tr><td colspan="5" class="table-cell text-center">No data available</td></tr>`;
        return;
    }
    cont.innerHTML = stats.map(s => {
        const color = s.trendDirection === 'up' ? 'green' : s.trendDirection === 'down' ? 'red' : 'gray';
        const icon = s.trendDirection === 'up' ? '¨J' : s.trendDirection === 'down' ? '¨K' : '¡ú';
        return `
            <tr>
                <td class="table-cell table-cell-main">${s.cancerType}</td>
                <td class="table-cell">${s.totalCases.toLocaleString()}</td>
                <td class="table-cell">${s.newCases}</td>
                <td class="table-cell">${s.percentage}</td>
                <td class="table-cell"><span class="trend-${color}">${icon} ${s.trend}</span></td>
            </tr>
        `;
    }).join('');
}

// =====================
// Initialization
// =====================
document.addEventListener('DOMContentLoaded', function() {
    // Only load data when this page is actively viewed
    if (document.visibilityState === 'visible') {
        loadRealDashboard(false);
    }
});

// Listen for page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Page became visible
    }
});
</script>

<style>
/* Your existing CSS styles */
.quick-actions { margin: 30px 0; }
.action-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
.action-btn { 
    background: #007acc; color: white; border: none; padding: 12px 20px; 
    border-radius: 6px; cursor: pointer; display: flex; align-items: center; 
    gap: 8px; font-size: 14px; transition: background-color 0.2s; 
}
.action-btn:hover { background: #005a9e; }

.metrics-grid { 
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px; margin-bottom: 30px; 
}
.metric-card { background: #252526; padding: 25px; border-radius: 8px; border-left: 4px solid; }
.metric-blue { border-left-color: #007acc; }
.metric-green { border-left-color: #4ec9b0; }
.metric-purple { border-left-color: #c586c0; }
.metric-pink { border-left-color: #ce9178; }
.metric-content { display: flex; align-items: center; justify-content: space-between; }
.metric-label { margin: 0 0 8px 0; color: #cccccc; font-size: 14px; font-weight: normal; }
.metric-value { font-size: 2em; font-weight: bold; color: #ffffff; margin: 0; }
.metric-icon { width: 50px; height: 50px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.metric-emoji { font-size: 1.5em; }

.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
.chart-card { background: #252526; padding: 25px; border-radius: 8px; border: 1px solid #3e3e42; }
.chart-title { margin: 0 0 20px 0; color: #ffffff; font-size: 18px; font-weight: 600; }
.chart-container { height: 320px; position: relative; }

/* Statistics Table Styles */
.stats-table-card { background: #252526; padding: 25px; border-radius: 8px; border: 1px solid #3e3e42; }
.stats-table-title { margin: 0 0 20px 0; color: #ffffff; font-size: 18px; font-weight: 600; }
.table-container { overflow-x: auto; }
.stats-table { width: 100%; border-collapse: collapse; }
.table-header { 
    background: #2d2d30; 
    padding: 12px 16px; 
    text-align: left; 
    font-weight: 600; 
    color: #cccccc;
    border-bottom: 1px solid #3e3e42;
}
.table-cell { 
    padding: 12px 16px; 
    border-bottom: 1px solid #3e3e42;
    color: #cccccc;
}
.table-cell-main { 
    font-weight: 500; 
    color: #ffffff;
}
.table-loading {
    text-align: center;
    padding: 40px;
    color: #888;
}

/* Trend colors */
.trend-green { color: #4ec9b0; }
.trend-red { color: #f48771; }
.trend-gray { color: #888; }

.metric-loading, .activity-loading {
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    padding: 40px; color: #888; 
}
.loading-spinner-small {
    width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid #007acc; 
    border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; 
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.error-message {
    display: flex; align-items: center; gap: 10px; padding: 20px; 
    background: #2d2d30; border-radius: 6px; color: #f48771; grid-column: 1 / -1;
}
</style>